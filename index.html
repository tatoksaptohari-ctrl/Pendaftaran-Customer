<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pendaftaran Pelanggan Baru</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f4f7f6; font-family: sans-serif; }
        .form-card { border: none; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); background: #fff; overflow: hidden; }
        .header-brand { background: #0056b3; color: white; padding: 20px; text-align: center; }
        
        /* CSS Penting agar Map Muncul */
        #map { 
            height: 300px; 
            width: 100%; 
            border-radius: 8px; 
            border: 2px solid #ddd; 
            background-color: #e5e3df; /* Warna dasar sebelum map dimuat */
            z-index: 1;
        }
        
        .btn-send { background-color: #25d366; color: white; font-weight: bold; border-radius: 30px; transition: 0.3s; border: none; }
        .btn-send:hover { background-color: #1ebe57; color: white; transform: scale(1.02); }
        label { font-weight: 600; color: #444; }
    </style>
</head>
<body>

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="form-card">
                <div class="header-brand">
                    <h4 class="mb-0">Form Registrasi Pelanggan</h4>
                </div>
                <div class="card-body p-4">
                    <form id="waForm">
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap</label>
                            <input type="text" id="nama" class="form-control" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nomor WhatsApp</label>
                                <input type="tel" id="nohp" class="form-control" placeholder="08xxxx" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nomor KTP (16 Digit)</label>
                                <input type="number" id="ktp" class="form-control" required>
                                <div id="ktpError" class="text-danger small mt-1" style="display:none;">Harus 16 digit!</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Merk Modem</label>
                                <input type="text" id="merk_modem" class="form-control" placeholder="ZTE / Huawei" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">SN Modem</label>
                                <input type="text" id="sn_modem" class="form-control" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Pilih Paket Berlangganan</label>
                            <select id="paket" class="form-select" onchange="toggleLainnya()" required>
                                <option value="" disabled selected>Pilih Paket...</option>
                                <option value="110">Paket 110</option>
                                <option value="135">Paket 135</option>
                                <option value="166">Paket 166</option>
                                <option value="222">Paket 222</option>
                                <option value="Lainnya">Lainnya (Isi Manual)</option>
                            </select>
                        </div>

                        <div class="mb-3" id="inputLainnya" style="display:none;">
                            <label class="form-label">Isi Paket Manual</label>
                            <input type="text" id="paketManual" class="form-control">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Alamat Lengkap</label>
                            <textarea id="alamat" class="form-control" rows="2" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label text-primary"><b>Tag Lokasi (Geser Pin Peta):</b></label>
                            <div id="map"></div>
                            <input type="hidden" id="lat">
                            <input type="hidden" id="lng">
                        </div>

                        <button type="submit" class="btn btn-send w-100 p-3 mt-2">KIRIM DATA KE WHATSAPP</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Gunakan koordinat default (Jakarta)
    var defaultLat = -6.2088;
    var defaultLng = 106.8456;

    // Inisialisasi Map dengan setting tambahan agar stabil di Android
    var map = L.map('map', {
        center: [defaultLat, defaultLng],
        zoom: 13,
        tap: false // Mencegah konflik klik pada beberapa perangkat Android
    });

    // Menggunakan ArcGIS Tile Layer (Lebih stabil untuk aplikasi Android)
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri'
    }).addTo(map);

    var marker = L.marker([defaultLat, defaultLng], {draggable: true}).addTo(map);

    function updateCoords(lat, lng) {
        document.getElementById('lat').value = lat.toFixed(6);
        document.getElementById('lng').value = lng.toFixed(6);
    }
    updateCoords(defaultLat, defaultLng);

    marker.on('dragend', function(e) {
        var p = marker.getLatLng();
        updateCoords(p.lat, p.lng);
    });

    // Mencegah peta blank saat layar diputar atau dimuat ulang
    setTimeout(function(){ map.invalidateSize(); }, 500);

    function toggleLainnya() {
        var paketSelect = document.getElementById('paket').value;
        var divLainnya = document.getElementById('inputLainnya');
        divLainnya.style.display = (paketSelect === "Lainnya") ? 'block' : 'none';
    }

    document.getElementById('waForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        var ktp = document.getElementById('ktp').value;
        if (ktp.length !== 16) {
            document.getElementById('ktpError').style.display = 'block';
            return;
        }

        var nama = document.getElementById('nama').value;
        var nohp = document.getElementById('nohp').value;
        var merk = document.getElementById('merk_modem').value;
        var sn = document.getElementById('sn_modem').value;
        var alamat = document.getElementById('alamat').value;
        var lat = document.getElementById('lat').value;
        var lng = document.getElementById('lng').value;
        
        var paketTerpilih = document.getElementById('paket').value;
        if (paketTerpilih === "Lainnya") {
            paketTerpilih = document.getElementById('paketManual').value;
        }

        var adminNumber = "628113718494";
        var text = `*PENDAFTARAN CUSTOMER BARU*%0A` +
                   `--------------------------%0A` +
                   `üë§ Nama: ${nama}%0A` +
                   `üì± WA: ${nohp}%0A` +
                   `üÜî KTP: ${ktp}%0A` +
                   `üîå Merk Modem: ${merk}%0A` +
                   `üî¢ SN Modem: ${sn}%0A` +
                   `üì¶ Paket: ${paketTerpilih}%0A` +
                   `üè† Alamat: ${alamat}%0A` +
                   `üìç Lokasi: https://www.google.com/maps?q=${lat},${lng}%0A` +
                   `--------------------------`;

        window.open(`https://api.whatsapp.com/send?phone=${adminNumber}&text=${text}`, '_blank');
    });
</script>
</body>
</html>
