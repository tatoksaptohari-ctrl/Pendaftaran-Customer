<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aplikasi Pendaftaran WiFi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { background-color: #f0f2f5; padding-bottom: 40px; }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { background: #0056b3; color: white; padding: 20px; border-radius: 15px 15px 0 0; text-align: center; }
        #map { height: 280px; width: 100%; border-radius: 10px; border: 1px solid #ccc; }
        .btn-submit { background: #25d366; color: white; font-weight: bold; border-radius: 50px; padding: 12px; border: none; width: 100%; margin-top: 10px; }
        .btn-gps { background: #007bff; color: white; font-size: 12px; border-radius: 5px; border: none; padding: 5px 10px; margin-bottom: 5px; }
        label { font-weight: 600; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="header"><h4>Form Pendaftaran Pelanggan</h4></div>
                <div class="card-body p-4">
                    <form id="regForm">
                        <div class="mb-3">
                            <label class="form-label">Nama Lengkap Pelanggan</label>
                            <input type="text" id="nama" class="form-control" placeholder="Nama sesuai KTP" required>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3">
                                <label class="form-label">No. WhatsApp Pelanggan</label>
                                <input type="tel" id="nowa_pelanggan" class="form-control" placeholder="08xxx" required>
                            </div>
                            <div class="col-6 mb-3">
                                <label class="form-label">No. HP Cadangan</label>
                                <input type="tel" id="nohp_pelanggan" class="form-control" placeholder="08xxx">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">NIK KTP (16 Digit)</label>
                            <input type="number" id="ktp" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Alamat Lengkap Pemasangan</label>
                            <textarea id="alamat" class="form-control" rows="3" placeholder="Nama jalan, Blok, No Rumah, RT/RW" required></textarea>
                        </div>
                        <div class="row">
                            <div class="col-6 mb-3"><label class="form-label">Merk Modem</label><input type="text" id="merk" class="form-control" required></div>
                            <div class="col-6 mb-3"><label class="form-label">SN Modem</label><input type="text" id="sn" class="form-control" required></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Paket Berlangganan</label>
                            <select id="paket" class="form-select" onchange="checkPaket()" required>
                                <option value="110">Paket 110</option>
                                <option value="135">Paket 135</option>
                                <option value="166">Paket 166</option>
                                <option value="222">Paket 222</option>
                                <option value="Lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div id="manualDiv" class="mb-3" style="display:none;">
                            <input type="text" id="paketManual" class="form-control" placeholder="Isi paket manual">
                        </div>
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <label class="text-primary">Tag Lokasi Pelanggan:</label>
                                <button type="button" class="btn-gps" onclick="getLocation()">Ambil Titik GPS</button>
                            </div>
                            <div id="map"></div>
                            <input type="hidden" id="lat"><input type="hidden" id="lng">
                        </div>
                        <button type="submit" id="btnProses" class="btn-submit">DAFTARKAN PELANGGAN</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const URL_SHEETS = 'https://script.google.com/macros/s/AKfycbz-yHr8YyCHLFaHRebRa1I426EkFmOzZSjLnitJnSujOvwcSAttjTaJH2fQwKgoLvD0Ng/exec';
    const NOMOR_ADMIN = '628113718494';

    var map = L.map('map').setView([-6.2000, 106.8000], 13);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);
    var marker = L.marker([-6.2000, 106.8000], {draggable: true}).addTo(map);

    function updateInputs(lat, lng) {
        document.getElementById('lat').value = lat;
        document.getElementById('lng').value = lng;
    }

    marker.on('dragend', function() {
        var pos = marker.getLatLng();
        updateInputs(pos.lat.toFixed(6), pos.lng.toFixed(6));
    });

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;
                marker.setLatLng([lat, lng]);
                map.setView([lat, lng], 17);
                updateInputs(lat.toFixed(6), lng.toFixed(6));
            });
        }
    }
    window.onload = getLocation;

    function checkPaket() {
        document.getElementById('manualDiv').style.display = (document.getElementById('paket').value === 'Lainnya') ? 'block' : 'none';
    }

    document.getElementById('regForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const btn = document.getElementById('btnProses');
        btn.disabled = true;
        btn.innerText = "Menyimpan...";

        let pkt = document.getElementById('paket').value;
        if(pkt === 'Lainnya') pkt = document.getElementById('paketManual').value;

        const lat = document.getElementById('lat').value;
        const lng = document.getElementById('lng').value;
        const linkMap = `https://www.google.com/maps?q=${lat},${lng}`;

        const params = new URLSearchParams({
            nama: document.getElementById('nama').value,
            nowa: document.getElementById('nowa_pelanggan').value,
            nohp: document.getElementById('nohp_pelanggan').value,
            ktp: document.getElementById('ktp').value,
            alamat: document.getElementById('alamat').value,
            merk: document.getElementById('merk').value,
            sn: document.getElementById('sn').value,
            paket: pkt,
            lokasi: linkMap
        });

        fetch(URL_SHEETS, { method: 'POST', mode: 'no-cors', body: params })
        .then(() => {
            const pesan = `*PENDAFTARAN PELANGGAN BARU*%0A` +
                          `üë§ Nama: ${document.getElementById('nama').value}%0A` +
                          `üí¨ WA Pelanggan: ${document.getElementById('nowa_pelanggan').value}%0A` +
                          `üìû HP Cadangan: ${document.getElementById('nohp_pelanggan').value}%0A` +
                          `üÜî KTP: ${document.getElementById('ktp').value}%0A` +
                          `üè† Alamat: ${document.getElementById('alamat').value}%0A` +
                          `üîå Modem: ${document.getElementById('merk').value} (${document.getElementById('sn').value})%0A` +
                          `üì¶ Paket: ${pkt}%0A` +
                          `üìç Lokasi: ${linkMap}`;
            
            window.open(`https://api.whatsapp.com/send?phone=${NOMOR_ADMIN}&text=${pesan}`, '_blank');
            btn.disabled = false;
            btn.innerText = "DAFTARKAN PELANGGAN";
        });
    });
</script>
</body>
</html>
